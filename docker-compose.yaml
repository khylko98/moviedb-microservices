version: '3'

services:
  service_registry:
    container_name: service-registry
    build: ./service-registry
    ports:
      - "8761:8761"
  
  config_server:
    container_name: config-server
    build: ./config-server
    ports:
      - "8088:8088"
    depends_on:
      - service_registry

  zipkin:
    container_name: zipkin
    image: openzipkin/zipkin
    ports:
      - "9411:9411"

  db:
    container_name: database
    image: postgres:15
    environment:
      POSTGRES_DB: moviedb
      POSTGRES_USER: username
      POSTGRES_PASSWORD: password
      PGDATA: /data/postgres
    volumes:
      - db:/data/postgres
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5332:5432"
    networks:
      - db

  api_gateway:
    container_name: api-gateway
    build: ./api-gateway
    ports:
      - "8060:8060"
    environment:
      - eureka.client.service-url.defaultZone=http://service-registry:8761/eureka
    depends_on:
      - service_registry
      - config_server
      - zipkin

networks:
  db:
    driver: bridge

volumes:
  db:
